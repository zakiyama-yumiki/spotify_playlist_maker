# ライブ後“余韻プレイリスト”作成アプリ 要件ドラフト（Spotify連携）

> 目的：ライブ（コンサート）参戦後、当日のセットリスト順でSpotifyプレイリストをワンタップ生成し、余韻に浸れる体験を自動化する。

---

## 1. 背景・課題

- 現状：手動で「プレイリスト作成 → 曲検索 → 追加」を曲数分繰り返す必要があり手間。
- 課題：曲数が多い／タイトル表記揺れ／未配信曲や地域制限で見つからない／別バージョン（Live/Remix/Remaster）が混在。
- 目標：事前にまとめた「文字のセットリスト」を読み込み、**同じ曲順**で**自動**プレイリスト化。

## 2. 対象ユーザー

- ライブ参戦者、遠征勢、フェス参加者。
- セットリストをSNSやファンサイトから取得・メモしている人。

## 3. 価値・成功指標（仮）

- 生成完了までの平均時間（< 20秒/30曲を目標）。
- 自動マッチ率（= 手動修正不要の曲割合）（> 90%）。
- 1回の操作で完了（ワンクリック体験）。
- 初回離脱率の低減、リピート率。

---

## 4. スコープ

### 4.1 MVP（必須）

- **テキストのセットリスト入力**：ペースト/手入力をサポート（ファイル読み込みは後回し）。OCRは現状スコープ外（費用対効果低）。
- **アーティスト指定**：まずは手入力（バリデーション含む）。将来は候補サジェスト追加。
- **Spotify認可 & プレイリスト自動作成**：公開/非公開を作成時に選択可能。
- **曲検索→一致判定→順序通り一括追加**：100曲/リクエストの分割実装必須。
- **結果画面**：成功/未一致/代替候補を提示。手動置換→再適用が可能。

### 4.2 以降の拡張（Nice to have）

- セットリスト自動取得（Setlist.fm等の外部API）
- バージョン優先度の細かな制御（Live/Studio/Remaster/Acoustic）
- Apple Music/YouTube Music など他サービスへのブリッジ
- シェア用リンク生成／埋め込みカード
- 履歴・再生成・差分更新（ツアー別テンプレ）
- 日本語/英語 UI、ダークモード

---

## 5. ユーザーフロー（MVP）

1. ユーザーがアプリを開く
2. アーティスト名を**手入力**
3. セットリストをテキストエリアへ**ペースト/手入力**
4. オプション設定（公開/非公開、重複除去、バージョン優先度）
5. 「プレイリスト作成」をクリック
6. 検索＆一致判定→順序通りに追加（100曲ごとに分割）
7. 結果画面：成功一覧＋**未一致の代替候補**を提示（ユーザーが選択→再適用）
8. 完了→「Spotifyで開く」

---

## 6. 入力仕様（セットリストテキスト）

### 6.1 入力方法（現状）

- **テキストエリア**：ペースト/手入力をサポート。
- ファイル読み込み：**非MVP**（将来の拡張）。
- OCR：**採用しない**（コスト高）。

### 6.2 受け入れフォーマット例

```
01. Overture
02. 青い栞
— MC —
03. Sparkle (Live at Tokyo)
[Encore]
04. 前前前世
```

### 6.3 正規化ルール（抜粋）

- 番号/記号のゆらぎ吸収、括弧内タグ抽出（Live/Remix など）。
- 日本語表記ゆらぎの吸収（全角半角、〜/～ 等）。
- 非楽曲行（MC/SE/Interlude）を除外（設定で説明欄へ記録可）。

---

## 7. 楽曲一致ロジック（検索戦略）

1. **アーティスト確定**：Spotify Artist ID を先に解決
2. **厳密一致**：曲名（正規化後）+ アーティストID で検索
3. **バリアント優先**：ユーザー設定の優先度に従いフィルタ（例：Studio > Live > Acoustic > Remix > Remaster）
4. **メタデータ一致**：ISRC一致があれば最優先
5. **ゆるめ一致**：サブタイトルやカッコ書きの有無を許容（`(Live at …)` など）
6. **地域可用性**：`market=from_token` を基本に、不可なら代替（別アルバム/コンピ）
7. **候補提示**：スコア上位 3 件をUIに提示し、未一致は手動選択へ

---

## 8. Spotify連携（技術）

- 認可：Authorization Code Flow (PKCE)。必要スコープ：`playlist-modify-private`（必須）、`playlist-modify-public`（公開時）。
- プレイリスト作成時のオプション：`name`（デフォルト：`{artist} {date} Setlist`）、`public`（true/false）、`description`にEncore等の区切りを追記可。
- 曲追加：`POST /v1/playlists/{playlist_id}/tracks` を**100曲単位で分割**。順序維持。
- 検索：`GET /v1/search`（type=track, market=from_token）。アーティストID確定後に絞り込み。
- レート制限：429の`Retry-After`を順守、指数バックオフ。

### 一致判定アルゴリズム（詳細）

1. 厳密一致（正規化後タイトル＋アーティストID）
2. バリアント優先（ユーザー設定：Studio > Live > Acoustic > Remix > Remasterなど）
3. ISRC一致があれば最優先
4. ゆるめ一致（括弧・サブタイトル無視、距離スコア）
5. 地域不可の場合は代替（別アルバム/編集盤）

---

## 9. エラーハンドリング/例外

- 入力不備：アーティスト未入力、セットリストが空→フォームにエラー表示
- 未配信/地域制限：代替候補 or スキップ、説明欄に注記
- 未一致：候補上位3件の提示、ユーザー選択で置換→再実行
- 429/5xx：指数バックオフ、進捗UIに再試行表示
- タイムアウト：部分結果を保持し、未処理行を再試行対象として提示

---

## 10. 設定項目（MVP想定）

- 公開/非公開（デフォルト：非公開）
- バージョン優先度（ドラッグで並び替え）
- 非楽曲行の扱い（除外／説明欄へ記載）
- 未一致処理（スキップ or 候補必須）
- 重複曲の扱い（そのまま/最新テイク/最初の一致）

---

## 11. UIラフ（テキスト）

### 画面A：入力

- フィールド
  - Artist（テキスト入力）※将来はサジェスト
  - セットリスト（テキストエリア：行ごと）
  - オプション：公開/非公開、重複除去、バージョン優先度（ドラッグで並べ替え）
- ボタン
  - [プレイリスト作成]

### 画面B：結果

- 成功リスト（順序表示：トラック名／アルバム／所要時間合計）
- **未一致**カード：各行に対し候補上位3件（アートワーク/曲名/アルバム/長さ）をラジオ選択→[この候補で置換]
- 一括操作：[未一致をスキップして作成完了] / [選択を適用して再実行]
- 最終：[Spotifyで開く]

---

## 12. 非機能要件

- パフォーマンス：30曲で20秒以内（検索並列化＋バッチ追加）
- 安定性：429/5xxリトライ、タイムアウトはユーザーに可視化
- セキュリティ：PKCE、アクセストークンの安全管理、ログに個人データを残さない
- 規約順守：Spotify開発者規約/ブランドガイドライン遵守
- ログ/可観測性：一致率、429発生率、平均処理時間

---

## 13. テスト計画

- 単体
  - パーサ：番号/区切り/日本語ゆらぎ/Encore検出
  - 正規化：全角半角/記号類/括弧タグ抽出
  - 検索：厳密/ゆるめ一致の境界ケース
- 結合
  - 30曲/50曲/120曲での時間・順序保持
  - 地域制限時の代替提示
- E2E
  - 実トークンでのプレイリスト作成→Spotifyで開く

---

## 14. リスク & 対応

- 配信/権利の事情で未登録曲：代替や空行保持
- API変更/制限強化：アダプタ層で吸収、機能フラグ
- セットリストの誤記：候補提示と手動介入

---

## 15. 開発タスク（MVP）

- [ ] 入力パーサ＆正規化ユーティリティ（日本語表記対応）
- [ ] Spotify OAuth（PKCE）+ スコープ実装
- [ ] アーティスト解決→検索→一致判定→URI配列生成
- [ ] 追加バッチャ（100曲/チャンク）＆順序維持
- [ ] UI：入力/結果（未一致候補UI含む）
- [ ] エラーハンドリング＆ログ（一致率/処理時間/429率）
- [ ] E2Eテスト（モックAPI）

---

## 16. 受け入れ基準（Definition of Done）

- **入力**：ペースト/手入力のみでセットリストを投入できる（ファイル/OCRなし）。
- **アーティスト指定**：手入力でバリデーション（未入力時はエラー）。
- **作成**：公開/非公開を選べ、プレイリストが**順序通り**に作成される。
- **追加**：100曲を超える場合も分割して全件追加される。
- **結果**：成功/未一致/代替候補が表示され、候補選択→再適用で確定できる。
- **精度**：代表的入力で自動マッチ率90%以上。

---

## 17. 将来アイデア

- セットリスト自動取得（公演日/会場で検索）
- イントロSE/MCを説明欄に章立て記録
- Spotify以外へのエクスポート
- セトリ比較（ツアー別で差分表示）
- ライブ終了後に自動通知→ワンタップ生成

---

### 付録：パース規則の詳細（ドラフト）

- 行ごとにトークン化：`番号? + タイトル + (サブ情報)?`
- 無視ルール：`/^(MC|Talk|Interlude|SE|Intro|Outro|Band Intro)/i`
- セクション検出：`\[(Encore|MC)\]|<Encore>` など
- タイトル正規化例：
  - 括弧の中身をタグ化（`(Live at…)` → variant=Live）
  - 記号の統一（`〜`/`～`→`~`、`・`→空白）
  - 前後空白/ピリオド/番号の削除

技術スタック

- UI: React + Vite（ビルド → dist をWorkerにバンドル）
- API: Honoで実装
- KV/D1: OAuthセッションやログ格納
- デプロイ先　cloudflare worker
